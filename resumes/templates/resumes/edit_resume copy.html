{% extends 'resumes/base.html' %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
<style>
    .fixed-save-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="{ 
    activeSection: null,
    toggleSection(section) {
        this.activeSection = this.activeSection === section ? null : section;
    }
}" class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Edit Resume: {{ resume.title }}</h1>

    <!-- Resume Title -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('title')">
            Resume Title
            <span x-show="activeSection !== 'title'">&plus;</span>
            <span x-show="activeSection === 'title'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'title'">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" name="update_title" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Update Title
                </button>
            </form>
        </div>
    </div>

    <!-- Personal Information -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('personal')">
            Personal Information
            <span x-show="activeSection !== 'personal'">&plus;</span>
            <span x-show="activeSection === 'personal'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'personal'">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                {{ personal_info_form.as_p }}
                <button type="submit" name="update_personal_info" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Update Personal Information
                </button>
            </form>
        </div>
    </div>

    <!-- Work Experience -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('work')">
            Work Experience
            <span x-show="activeSection !== 'work'">&plus;</span>
            <span x-show="activeSection === 'work'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'work'">
            {% for experience in work_experiences %}
                <div class="mb-4 p-4 border rounded">
                    <h3 class="text-xl font-semibold">{{ experience.job_title }} at {{ experience.company }}</h3>
                    <p>{{ experience.start_date }} - {{ experience.end_date|default:"Present" }}</p>
                    <p>{{ experience.description }}</p>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="experience_id" value="{{ experience.id }}">
                        <button type="submit" name="delete_work_experience" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Work Experience</h3>
                {{ work_experience_form.as_p }}
                <button type="submit" name="add_work_experience" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Work Experience
                </button>
            </form>
        </div>
    </div>

    <!-- Education -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('education')">
            Education
            <span x-show="activeSection !== 'education'">&plus;</span>
            <span x-show="activeSection === 'education'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'education'">
            {% for edu in education_entries %}
                <div class="mb-4 p-4 border rounded">
                    <h3 class="text-xl font-semibold">{{ edu.degree }} in {{ edu.major }}</h3>
                    <p>{{ edu.institution }}, {{ edu.location }}</p>
                    <p>{{ edu.start_date }} - {{ edu.end_date|default:"Present" }}</p>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="education_id" value="{{ edu.id }}">
                        <button type="submit" name="delete_education" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Education</h3>
                {{ education_form.as_p }}
                <button type="submit" name="add_education" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Education
                </button>
            </form>
        </div>
    </div>

    <!-- Skills -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('skills')">
            Skills
            <span x-show="activeSection !== 'skills'">&plus;</span>
            <span x-show="activeSection === 'skills'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'skills'">
            {% for skill in skills %}
                <div class="mb-2">
                    <span>{{ skill.name }} - {{ skill.level }}</span>
                    <form method="post" class="inline ml-2">
                        {% csrf_token %}
                        <input type="hidden" name="skill_id" value="{{ skill.id }}">
                        <button type="submit" name="delete_skill" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Skill</h3>
                {{ skill_form.as_p }}
                <button type="submit" name="add_skill" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Skill
                </button>
            </form>
        </div>
    </div>

    <!-- Projects -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('projects')">
            Projects
            <span x-show="activeSection !== 'projects'">&plus;</span>
            <span x-show="activeSection === 'projects'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'projects'">
            {% for project in projects %}
                <div class="mb-4 p-4 border rounded">
                    <h3 class="text-xl font-semibold">{{ project.name }}</h3>
                    <p>{{ project.description }}</p>
                    <p>Technologies: {{ project.technologies }}</p>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="project_id" value="{{ project.id }}">
                        <button type="submit" name="delete_project" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Project</h3>
                {{ project_form.as_p }}
                <button type="submit" name="add_project" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Project
                </button>
            </form>
        </div>
    </div>

    <!-- Certifications -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('certifications')">
            Certifications
            <span x-show="activeSection !== 'certifications'">&plus;</span>
            <span x-show="activeSection === 'certifications'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'certifications'">
            {% for cert in certifications %}
                <div class="mb-4 p-4 border rounded">
                    <h3 class="text-xl font-semibold">{{ cert.name }}</h3>
                    <p>{{ cert.organization }}</p>
                    <p>Obtained: {{ cert.date_obtained }}</p>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="certification_id" value="{{ cert.id }}">
                        <button type="submit" name="delete_certification" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Certification</h3>
                {{ certification_form.as_p }}
                <button type="submit" name="add_certification" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Certification
                </button>
            </form>
        </div>
    </div>

    <!-- Languages -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('languages')">
            Languages
            <span x-show="activeSection !== 'languages'">&plus;</span>
            <span x-show="activeSection === 'languages'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'languages'">
            {% for lang in languages %}
                <div class="mb-2">
                    <span>{{ lang.name }} - {{ lang.proficiency }}</span>
                    <form method="post" class="inline ml-2">
                        {% csrf_token %}
                        <input type="hidden" name="language_id" value="{{ lang.id }}">
                        <button type="submit" name="delete_language" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Language</h3>
                {{ language_form.as_p }}
                <button type="submit" name="add_language" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Language
                </button>
            </form>
        </div>
    </div>

    <!-- References -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('references')">
            References
            <span x-show="activeSection !== 'references'">&plus;</span>
            <span x-show="activeSection === 'references'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'references'">
            {% for ref in references %}
                <div class="mb-4 p-4 border rounded">
                    <h3 class="text-xl font-semibold">{{ ref.reference_name }}</h3>
                    <p>{{ ref.position }} at {{ ref.organization }}</p>
                    <p>Email: {{ ref.email }}</p>
                    <p>Phone: {{ ref.phone }}</p>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="reference_id" value="{{ ref.id }}">
                        <button type="submit" name="delete_reference" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Reference</h3>
                {{ reference_form.as_p }}
                <button type="submit" name="add_reference" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Reference
                </button>
            </form>
        </div>
    </div>

    <!-- Custom Sections -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold mb-4 cursor-pointer" @click="toggleSection('custom')">
            Custom Sections
            <span x-show="activeSection !== 'custom'">&plus;</span>
            <span x-show="activeSection === 'custom'">&minus;</span>
        </h2>
        <div x-show="activeSection === 'custom'">
            {% for section in custom_sections %}
                <div class="mb-4 p-4 border rounded">
                    <h3 class="text-xl font-semibold">{{ section.section_name }}</h3>
                    <div>{{ section.content|safe }}</div>
                    <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="custom_section_id" value="{{ section.id }}">
                        <button type="submit" name="delete_custom_section" class="text-red-500 hover:text-red-700">Delete</button>
                    </form>
                </div>
            {% endfor %}
            <form method="post" class="space-y-6 mt-8">
                {% csrf_token %}
                <h3 class="text-xl font-semibold mb-2">Add New Custom Section</h3>
                {{ custom_section_form.as_p }}
                <button type="submit" name="add_custom_section" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Add Custom Section
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Function to save form data
    document.addEventListener('DOMContentLoaded', function() {

        // Enhanced notification system
        function showNotification(message, type = 'success') {
            const notifications = document.getElementById('notifications');
            const toast = document.createElement('div');
            
            toast.className = `notification ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notifications.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Function to handle form submission via AJAX
        function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
    
            // Determine the action based on the submit button name
            const submitButton = form.querySelector('button[type="submit"]');
            const actionName = submitButton ? submitButton.getAttribute('name') : null;
    
            // Add the action name to the form data
            if (actionName) {
                formData.append(actionName, 'true');
            }
    
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message
                    showNotification('Section updated successfully!', 'success');
                    
                    // Optionally, you can refresh the section or update specific elements
                    if (data.html) {
                        // If the server returns updated HTML for a specific section
                        const sectionContainer = form.closest('.mb-6');
                        if (sectionContainer) {
                            sectionContainer.innerHTML = data.html;
                        }
                    }
                } else {
                    // Show error message
                    showNotification(data.message || 'Error updating section. Please try again.', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while saving. Please try again.', 'error');
            });
        }
    
        // Notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded shadow-lg ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.textContent = message;
    
            // Add to body
            document.body.appendChild(notification);
    
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
    
        // Add event listeners to all forms
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', handleFormSubmit);
        });
    });
</script>
{% endblock %}